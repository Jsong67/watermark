<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æ‰¹é‡åŠ æ°´å°å·¥å…·ã€+7AIå®éªŒå®¤ã€‘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&family=ZCOOL+KuaiLe&family=ZCOOL+QingKe+HuangYou&display=swap">
    <style>
        .canvas-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }
        .drag-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 40px;
            cursor: move;
        }
        .button-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: rgba(0,0,0,0.05);
        }
        .save-button {
            padding: 4px 12px;
            background: #4F46E5;
            color: white;
            border-radius: 4px;
            font-size: 14px;
        }
        .save-button:hover {
            background: #4338CA;
        }
        .extract-button {
            padding: 4px 12px;
            background: #10B981;
            color: white;
            border-radius: 4px;
            font-size: 14px;
        }
        .extract-button:hover {
            background: #059669;
        }
        .font-msz {
            font-family: 'Ma Shan Zheng', cursive;
        }
        .font-xw {
            font-family: 'ZCOOL XiaoWei', cursive;
        }
        .font-kl {
            font-family: 'ZCOOL KuaiLe', cursive;
        }
        .font-qkhy {
            font-family: 'ZCOOL QingKe HuangYou', cursive;
        }
        .font-noto {
            font-family: 'Noto Sans SC', sans-serif;
        }
        .banner-container {
            width: 100%;
            margin: 0 auto;
            padding: 1rem 0;
            text-align: center;
            background-color: #ffffff;
            max-width: 56rem;
        }
        .banner-image {
            width: 100%;
            height: auto;
            margin: 0 auto;
            display: block;
        }
        .fullscreen-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .download-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            text-align: center;
            min-width: 200px;
        }
        .batch-download-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .batch-download-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            width: 400px;
            text-align: center;
        }
        .download-option-btn {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin: 8px 0;
        }
        .download-option-btn:hover {
            background: #26a69a;
        }
        .download-option-btn.primary {
            background: #ff6b6b;
        }
        .download-option-btn.primary:hover {
            background: #ff5252;
        }
        .download-option-btn.secondary {
            background: #9c27b0;
        }
        .download-option-btn.secondary:hover {
            background: #7b1fa2;
        }
        .close-btn {
            background: #gray;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }
        .image-input-options {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .image-input-option {
            flex: 1;
            min-width: 80px;
            padding: 6px 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            transition: all 0.2s;
            color: #6c757d;
        }
        .image-input-option:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        .image-input-option:active {
            background: #dee2e6;
        }
        .hidden-input {
            position: absolute;
            width: 0;
            height: 0;
            opacity: 0;
            pointer-events: none;
        }
        .copy-success {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 3000;
            font-size: 16px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Banner -->
    <div class="max-w-4xl mx-auto">  
        <div class="banner-container">  
            <img src="https://i.ibb.co/NYByV7m/plus7banner.png"   
                 alt="plus7banner"  
                 class="banner-image">  
        </div>  
    </div>  

    <div class="max-w-4xl mx-auto p-4 space-y-6">
        <h1 class="text-2xl font-bold text-gray-900 text-center">å›¾ç‰‡æ‰¹é‡åŠ æ°´å°å·¥å…·</h1>
        <p class="text-right text-sm text-gray-500 mt-1">Designed by Yufan Chen & Jiaqi Song & AI</p>
        <div class="bg-white rounded-lg shadow p-6 space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©å›¾ç‰‡</label>
                <!-- ä¸»è¦çš„æ–‡ä»¶è¾“å…¥æ¡†ï¼Œé»˜è®¤æ‰“å¼€ç›¸å†Œ -->
                <input type="file" id="imageInput" multiple accept="image/*" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-md file:border-0
                    file:text-sm file:font-semibold
                    file:bg-indigo-50 file:text-indigo-700
                    hover:file:bg-indigo-100">
                
                <!-- é¢å¤–çš„è¾“å…¥é€‰é¡¹ -->
                <div class="image-input-options">
                    <div class="image-input-option" id="optionCamera">ğŸ“· ç›¸æœºæ‹ç…§</div>
                    <div class="image-input-option" id="optionFiles">ğŸ“ æ–‡ä»¶ç®¡ç†</div>
                </div>
                
                <!-- éšè—çš„è¾“å…¥æ¡† -->
                <input type="file" id="cameraInput" multiple accept="image/*" capture="environment" class="hidden-input">
                <input type="file" id="fileInput" multiple accept="image/*,*/*" class="hidden-input">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">æ°´å°æ–‡å­—</label>
                    <input type="text" id="watermarkText" value="+7AIå®éªŒå®¤" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">å­—ä½“é€‰æ‹©</label>
                    <select id="fontFamily" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="Noto Sans SC" class="font-noto">æ€æºé»‘ä½“</option>
                        <option value="Ma Shan Zheng" class="font-msz">é©¬å–„æ”¿æ¯›ç¬”å­—ä½“</option>
                        <option value="ZCOOL XiaoWei" class="font-xw">ç«™é…·å°è–‡å­—ä½“</option>
                        <option value="ZCOOL KuaiLe" class="font-kl">ç«™é…·å¿«ä¹ä½“</option>
                        <option value="ZCOOL QingKe HuangYou" class="font-qkhy">ç«™é…·åº†ç§‘é»„æ²¹ä½“</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">æ°´å°æ¨¡å¼</label>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="fullscreenWatermark" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <span class="ml-2 text-sm">å…¨å±æ°´å°</span>
                        </label>
                    </div>
                </div>
                <div class="space-y-2" id="positionContainer">
                    <label class="block text-sm font-medium text-gray-700">ä½ç½®é¢„è®¾</label>
                    <select id="positionPreset" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="center">å±…ä¸­</option>
                        <option value="top-left">å·¦ä¸Šè§’</option>
                        <option value="top-right">å³ä¸Šè§’</option>
                        <option value="bottom-left">å·¦ä¸‹è§’</option>
                        <option value="bottom-right">å³ä¸‹è§’</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">å­—ä½“ç²—ç»†</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="fontWeight" value="normal" checked>
                            <span class="ml-2">å¸¸è§„</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="fontWeight" value="bold">
                            <span class="ml-2">åŠ ç²—</span>
                        </label>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">
                        å­—ä½“å¤§å°ï¼š<span id="fontSizeValue">5</span>%
                    </label>
                    <input type="range" id="fontSize" min="1" max="20" value="5" step="0.5" class="w-full">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">
                        å¯è§æ°´å°é€æ˜åº¦ï¼š<span id="opacityValue">50</span>%
                    </label>
                    <input type="range" id="opacity" min="10" max="100" value="50" class="w-full">
                </div>
                <div class="space-y-2" id="spacingContainer">
                    <label class="block text-sm font-medium text-gray-700">
                        æ°´å°é—´è·ï¼š<span id="spacingValue">150</span>px
                    </label>
                    <input type="range" id="spacing" min="80" max="300" value="150" class="w-full">
                </div>
            </div>

            <div id="previewArea" class="hidden space-y-4">
                <h3 class="font-medium text-lg">é¢„è§ˆï¼ˆ<span id="dragHint">æ‹–åŠ¨å¯è°ƒæ•´å¯è§æ°´å°ä½ç½®</span>ï¼‰</h3>
                <div id="imagePreview" class="grid gap-4"></div>
                <div class="flex flex-col gap-2 md:flex-row md:gap-4">
                    <button id="downloadAll" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                        åœ¨æ–°é¡µé¢ä¸­æŸ¥çœ‹
                    </button>
                    <button id="saveAll" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                        <span id="saveAllText">æ‰¹é‡ä¿å­˜å›¾ç‰‡</span>
                    </button>
                    <button id="downloadZip" class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">
                        æ‰“åŒ…ä¸‹è½½ZIP
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡ä¿å­˜é€‰æ‹©çª—å£ -->
    <div id="batchDownloadModal" class="batch-download-container hidden">
        <div class="batch-download-box">
            <h3 style="margin-bottom: 20px; color: #333;">ğŸ“± é€‰æ‹©ä¿å­˜æ–¹å¼</h3>
            <div id="downloadOptions">
                <button id="combinedImageBtn" class="download-option-btn primary">
                    ğŸ–¼ï¸ ç”Ÿæˆæ‹¼å›¾ç‰ˆ (æ¨è)
                </button>
                <button id="manualDownloadBtn" class="download-option-btn">
                    ğŸ‘† é€ä¸ªæ‰‹åŠ¨ä¿å­˜
                </button>
                <button id="copyImageBtn" class="download-option-btn">
                    ğŸ“‹ å¤åˆ¶å›¾ç‰‡åˆ°å‰ªè´´æ¿
                </button>
                <button id="zipDownloadBtn" class="download-option-btn secondary">
                    ğŸ“¦ ä¸‹è½½ZIPå‹ç¼©åŒ…
                </button>
            </div>
            <button id="closeModal" class="close-btn" style="background: #666;">å…³é—­</button>
        </div>
    </div>

    <!-- ç®€å•ä¸‹è½½è¿›åº¦æç¤º -->
    <div id="downloadProgressSimple" class="download-progress hidden">
        <div class="mb-2">æ­£åœ¨å‡†å¤‡...</div>
        <div class="text-sm opacity-75">è¯·ç¨å€™</div>
    </div>

    <!-- å¤åˆ¶æˆåŠŸæç¤º -->
    <div id="copySuccess" class="copy-success hidden">
        âœ… å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿
    </div>
</body>
</html>

<script>
(() => {
    const state = {
        images: [],
        watermarkPos: { x: 0.5, y: 0.5 },
        isDragging: false,
        dragStartPos: null,
        currentCanvas: null,
        currentCopyIndex: 0
    };

    const POSITIONS = {
        'center': { x: 0.5, y: 0.5 },
        'top-left': { x: 0.01, y: 0.01 },
        'top-right': { x: 0.99, y: 0.01 },
        'bottom-left': { x: 0.01, y: 0.99 },
        'bottom-right': { x: 0.99, y: 0.99 }
    };

    const $ = id => document.getElementById(id);
    const els = {
        imageInput: $('imageInput'),
        cameraInput: $('cameraInput'),
        fileInput: $('fileInput'),
        optionCamera: $('optionCamera'),
        optionFiles: $('optionFiles'),
        watermarkText: $('watermarkText'),
        fontSize: $('fontSize'),
        fontFamily: $('fontFamily'),
        opacity: $('opacity'),
        spacing: $('spacing'),
        previewArea: $('previewArea'),
        imagePreview: $('imagePreview'),
        downloadAll: $('downloadAll'),
        saveAll: $('saveAll'),
        downloadZip: $('downloadZip'),
        fontSizeValue: $('fontSizeValue'),
        opacityValue: $('opacityValue'),
        spacingValue: $('spacingValue'),
        positionPreset: $('positionPreset'),
        fullscreenWatermark: $('fullscreenWatermark'),
        positionContainer: $('positionContainer'),
        spacingContainer: $('spacingContainer'),
        dragHint: $('dragHint'),
        downloadProgressSimple: $('downloadProgressSimple'),
        saveAllText: $('saveAllText'),
        batchDownloadModal: $('batchDownloadModal'),
        combinedImageBtn: $('combinedImageBtn'),
        manualDownloadBtn: $('manualDownloadBtn'),
        copyImageBtn: $('copyImageBtn'),
        zipDownloadBtn: $('zipDownloadBtn'),
        closeModal: $('closeModal'),
        downloadOptions: $('downloadOptions'),
        copySuccess: $('copySuccess')
    };

    // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // LSBæ°´å°ç¼–ç å‡½æ•°
    function encodeLSB(imageData, text) {
        const data = new Uint8ClampedArray(imageData.data);
        const binaryText = textToBinary(text);
        const bits = 2;
        const mask = (1 << bits) - 1;
        const inverseMask = ~mask & 0xFF;
        
        const textLength = binaryText.length;
        for(let i = 0; i < 32; i++) {
            const lengthBit = (textLength >> i) & 1;
            data[i * 4] = (data[i * 4] & inverseMask) | lengthBit;
        }

        for(let i = 0; i < binaryText.length; i++) {
            const pixelIndex = (i + 32) * 4;
            if(pixelIndex >= data.length) break;
            
            const textBits = parseInt(binaryText.substr(i * bits, bits) || '0', 2);
            data[pixelIndex] = (data[pixelIndex] & inverseMask) | textBits;
        }

        return new ImageData(data, imageData.width, imageData.height);
    }

    // LSBæ°´å°è§£ç å‡½æ•°
    function decodeLSB(imageData) {
        const data = imageData.data;
        let textLength = 0;
        const bits = 2;

        for(let i = 0; i < 32; i++) {
            const lengthBit = data[i * 4] & 1;
            textLength |= (lengthBit << i);
        }

        let binaryText = '';
        const mask = (1 << bits) - 1;
        
        for(let i = 0; i < textLength; i++) {
            const pixelIndex = (i + 32) * 4;
            if(pixelIndex >= data.length) break;
            
            const textBits = data[pixelIndex] & mask;
            binaryText += textBits.toString(2).padStart(bits, '0');
        }

        return binaryToText(binaryText);
    }

    function textToBinary(text) {
        let binary = '';
        for(let i = 0; i < text.length; i++) {
            binary += text.charCodeAt(i).toString(2).padStart(16, '0');
        }
        return binary;
    }

    function binaryToText(binary) {
        let text = '';
        for(let i = 0; i < binary.length; i += 16) {
            const charCode = parseInt(binary.substr(i, 16), 2);
            if(charCode === 0) break;
            text += String.fromCharCode(charCode);
        }
        return text;
    }

    function loadImage(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // ä¼˜åŒ–åçš„å…¨å±æ°´å°ç»˜åˆ¶å‡½æ•°
    function drawFullscreenWatermark(ctx, canvas, text, fontSize, opacity, weight, fontFamily) {
        const spacing = parseInt(els.spacing.value);
        
        ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
        ctx.font = `${weight} ${fontSize}px ${fontFamily}`;
        
        const textMetrics = ctx.measureText(text);
        const textWidth = textMetrics.width;
        const textHeight = fontSize;
        
        const stepX = Math.max(textWidth + spacing, 100);
        const stepY = Math.max(textHeight + spacing, 60);
        
        ctx.save();
        
        const angle = -Math.PI / 4;
        
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(angle);
        
        const diagonal = Math.sqrt(canvas.width * canvas.width + canvas.height * canvas.height);
        const coverSize = diagonal * 1.2;
        
        const maxCols = Math.min(Math.ceil(coverSize / stepX), 20);
        const maxRows = Math.min(Math.ceil(coverSize / stepY), 20);
        
        const startX = -(maxCols * stepX) / 2;
        const startY = -(maxRows * stepY) / 2;
        
        for(let row = 0; row < maxRows; row++) {
            for(let col = 0; col < maxCols; col++) {
                const x = startX + col * stepX;
                const y = startY + row * stepY;
                ctx.fillText(text, x, y);
            }
        }
        
        ctx.restore();
    }

    function createWatermarkedCanvas(img) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        
        ctx.drawImage(img, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const watermarkedData = encodeLSB(imageData, els.watermarkText.value);
        ctx.putImageData(watermarkedData, 0, 0);
        
        const opacity = els.opacity.value / 100;
        const weight = document.querySelector('input[name="fontWeight"]:checked').value;
        const fontSize = Math.round((els.fontSize.value / 100) * canvas.height);
        const text = els.watermarkText.value;
        const fontFamily = els.fontFamily.value;
        
        if (els.fullscreenWatermark.checked) {
            drawFullscreenWatermark(ctx, canvas, text, fontSize, opacity, weight, fontFamily);
        } else {
            ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
            ctx.font = `${weight} ${fontSize}px ${fontFamily}`;
            
            const x = state.watermarkPos.x * canvas.width;
            const y = state.watermarkPos.y * canvas.height;
            
            ctx.textAlign = x < canvas.width * 0.4 ? 'left' : x > canvas.width * 0.6 ? 'right' : 'center';
            ctx.textBaseline = y < canvas.height * 0.4 ? 'top' : y > canvas.height * 0.6 ? 'bottom' : 'middle';
            
            ctx.fillText(text, x, y);
        }
        
        return canvas;
    }

    function extractWatermark(img, resultContainer) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const extractedText = decodeLSB(imageData);
        
        resultContainer.classList.remove('hidden');
        resultContainer.innerHTML = extractedText ? 
            `<div class="bg-green-50 border border-green-200 rounded-md p-4 mt-2">
                <p class="text-green-800">æå–åˆ°æ°´å°å†…å®¹ï¼š<span class="font-semibold">"${extractedText}"</span></p>
            </div>` : 
            `<div class="bg-red-50 border border-red-200 rounded-md p-4 mt-2">
                <p class="text-red-800">æœªæ£€æµ‹åˆ°æ°´å°æˆ–æ°´å°å·²æŸå</p>
            </div>`;
    }

    function updateUIState() {
        const isFullscreen = els.fullscreenWatermark.checked;
        
        els.positionContainer.classList.toggle('fullscreen-disabled', isFullscreen);
        els.spacingContainer.classList.toggle('hidden', !isFullscreen);
        
        els.dragHint.textContent = isFullscreen ? 'å…¨å±æ°´å°æ¨¡å¼' : 'æ‹–åŠ¨å¯è°ƒæ•´å¯è§æ°´å°ä½ç½®';
        
        const overlays = document.querySelectorAll('.drag-overlay');
        overlays.forEach(overlay => {
            overlay.style.pointerEvents = isFullscreen ? 'none' : 'auto';
        });
    }

    function updatePreviews() {
        els.imagePreview.innerHTML = '';
        
        state.images.forEach((img, i) => {
            const container = document.createElement('div');
            container.className = 'space-y-2';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'canvas-wrapper';
            
            const canvas = createWatermarkedCanvas(img);
            canvas.className = 'w-full h-auto border rounded';
            
            const overlay = document.createElement('div');
            overlay.className = 'drag-overlay';
            overlay.style.height = 'calc(100% - 40px)';
            overlay.style.pointerEvents = els.fullscreenWatermark.checked ? 'none' : 'auto';
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'button-container';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'save-button';
            saveBtn.textContent = 'ä¿å­˜';
            saveBtn.onclick = (e) => {
                e.stopPropagation();
                downloadSingleImage(canvas, i + 1);
            };

            const extractBtn = document.createElement('button');
            extractBtn.className = 'extract-button';
            extractBtn.textContent = 'æå–æ°´å°';
            
            const resultContainer = document.createElement('div');
            resultContainer.className = 'hidden';
            
            extractBtn.onclick = (e) => {
                e.stopPropagation();
                extractWatermark(img, resultContainer);
            };
            
            buttonContainer.append(saveBtn, extractBtn);
            wrapper.append(canvas, overlay, buttonContainer);
            container.append(wrapper, resultContainer);
            els.imagePreview.appendChild(container);
        });
    }

    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelect(files) {
        Promise.all(Array.from(files).map(loadImage)).then(images => {
            state.images = images;
            els.previewArea.classList.remove('hidden');
            updateUIState();
            updatePreviews();
        });
    }

    // ä¸‹è½½å•ä¸ªå›¾ç‰‡
    function downloadSingleImage(canvas, index) {
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = `æ°´å°å›¾ç‰‡_${index}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ç”Ÿæˆæ‹¼å›¾ç‰ˆæœ¬ï¼ˆæ¨èæ–¹æ¡ˆï¼‰
    function createCombinedImage() {
        if (state.images.length === 0) return;
        
        els.downloadProgressSimple.classList.remove('hidden');
        els.downloadProgressSimple.querySelector('.mb-2').textContent = 'æ­£åœ¨ç”Ÿæˆæ‹¼å›¾ç‰ˆ...';
        
        setTimeout(() => {
            const canvases = state.images.map(img => createWatermarkedCanvas(img));
            
            // è®¡ç®—ç½‘æ ¼å¸ƒå±€
            const cols = Math.ceil(Math.sqrt(canvases.length));
            const rows = Math.ceil(canvases.length / cols);
            
            // æ‰¾å‡ºæœ€å¤§çš„å›¾ç‰‡å°ºå¯¸
            let maxWidth = 0;
            let maxHeight = 0;
            canvases.forEach(canvas => {
                maxWidth = Math.max(maxWidth, canvas.width);
                maxHeight = Math.max(maxHeight, canvas.height);
            });
            
            // è®¾ç½®åˆé€‚çš„å•å…ƒæ ¼å°ºå¯¸
            const cellWidth = Math.min(maxWidth, 800);
            const cellHeight = Math.min(maxHeight, 600);
            
            // åˆ›å»ºå¤§ç”»å¸ƒ
            const combinedCanvas = document.createElement('canvas');
            const ctx = combinedCanvas.getContext('2d');
            combinedCanvas.width = cols * cellWidth;
            combinedCanvas.height = rows * cellHeight;
            
            // ç™½è‰²èƒŒæ™¯
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);
            
            // ç»˜åˆ¶æ¯ä¸ªå›¾ç‰‡
            canvases.forEach((canvas, i) => {
                const col = i % cols;
                const row = Math.floor(i / cols);
                
                const x = col * cellWidth;
                const y = row * cellHeight;
                
                // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                const scaleX = cellWidth / canvas.width;
                const scaleY = cellHeight / canvas.height;
                const scale = Math.min(scaleX, scaleY, 1);
                
                const scaledWidth = canvas.width * scale;
                const scaledHeight = canvas.height * scale;
                
                // å±…ä¸­ç»˜åˆ¶
                const drawX = x + (cellWidth - scaledWidth) / 2;
                const drawY = y + (cellHeight - scaledHeight) / 2;
                
                ctx.drawImage(canvas, drawX, drawY, scaledWidth, scaledHeight);
                
                // æ·»åŠ è¾¹æ¡†
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, cellWidth, cellHeight);
                
                // æ·»åŠ åºå·
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.font = '16px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                ctx.fillText(`${i + 1}`, x + 5, y + 5);
            });
            
            els.downloadProgressSimple.classList.add('hidden');
            
            // åœ¨æ–°çª—å£æ˜¾ç¤º
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                    <head>
                        <title>æ‹¼å›¾ç‰ˆæ°´å°å›¾ç‰‡</title>
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <style>
                            body { 
                                margin: 0; 
                                padding: 20px; 
                                background: #f5f5f5; 
                                text-align: center;
                                font-family: Arial, sans-serif;
                            }
                            .container {
                                background: white;
                                padding: 20px;
                                border-radius: 10px;
                                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                                margin-bottom: 20px;
                            }
                            img { 
                                max-width: 100%; 
                                height: auto; 
                                border-radius: 8px;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            }
                            .tip { 
                                color: #666; 
                                font-size: 14px; 
                                margin-bottom: 15px;
                                line-height: 1.5;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <h2>æ‹¼å›¾ç‰ˆæ°´å°å›¾ç‰‡</h2>
                            <div class="tip">
                                ğŸ“± æ‰‹æœºç«¯ï¼šé•¿æŒ‰å›¾ç‰‡é€‰æ‹©"ä¿å­˜åˆ°ç›¸å†Œ"<br>
                                ğŸ’» ç”µè„‘ç«¯ï¼šå³é”®å›¾ç‰‡é€‰æ‹©"å¦å­˜ä¸º"<br>
                                å…± ${state.images.length} å¼ å›¾ç‰‡ï¼ŒæŒ‰åºå·æ’åˆ—
                            </div>
                            <img src="${combinedCanvas.toDataURL('image/png')}" alt="æ‹¼å›¾ç‰ˆæ°´å°å›¾ç‰‡">
                        </div>
                    </body>
                </html>
            `);
            
            closeBatchDownloadModal();
        }, 100);
    }

    // å¤åˆ¶å›¾ç‰‡åˆ°å‰ªè´´æ¿
    async function copyImageToClipboard() {
        if (state.images.length === 0) return;
        
        try {
            const canvas = createWatermarkedCanvas(state.images[state.currentCopyIndex]);
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            
            await navigator.clipboard.write([
                new ClipboardItem({
                    'image/png': blob
                })
            ]);
            
            showCopySuccess();
            
            // è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ 
            state.currentCopyIndex = (state.currentCopyIndex + 1) % state.images.length;
            
            if (state.currentCopyIndex === 0) {
                els.copyImageBtn.textContent = 'âœ… å·²å¤åˆ¶å®Œæ‰€æœ‰å›¾ç‰‡';
                els.copyImageBtn.disabled = true;
                setTimeout(() => {
                    els.copyImageBtn.textContent = 'ğŸ“‹ å¤åˆ¶å›¾ç‰‡åˆ°å‰ªè´´æ¿';
                    els.copyImageBtn.disabled = false;
                    state.currentCopyIndex = 0;
                }, 3000);
            } else {
                els.copyImageBtn.textContent = `ğŸ“‹ å¤åˆ¶ç¬¬${state.currentCopyIndex + 1}å¼  (${state.currentCopyIndex + 1}/${state.images.length})`;
            }
            
        } catch (error) {
            console.error('å¤åˆ¶å¤±è´¥:', error);
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–æ–¹æ³•');
        }
    }

    // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
    function showCopySuccess() {
        els.copySuccess.classList.remove('hidden');
        setTimeout(() => {
            els.copySuccess.classList.add('hidden');
        }, 2000);
    }

    // åˆ›å»ºæ‰‹åŠ¨ä¿å­˜é¡µé¢
    function createManualDownloadPage() {
        if (state.images.length === 0) return;
        
        const newWindow = window.open('', '_blank');
        
        newWindow.document.write(`
            <html>
                <head>
                    <title>æ‰‹åŠ¨ä¿å­˜å›¾ç‰‡</title>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        body { 
                            margin: 0; 
                            padding: 20px; 
                            background: #f5f5f5; 
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        }
                        .header {
                            background: white;
                            padding: 20px;
                            border-radius: 15px;
                            margin-bottom: 20px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                            text-align: center;
                        }
                        .instruction {
                            background: #e3f2fd;
                            color: #1976d2;
                            padding: 15px;
                            border-radius: 10px;
                            margin: 15px 0;
                            font-size: 14px;
                            line-height: 1.5;
                        }
                        .image-container {
                            background: white;
                            padding: 20px;
                            border-radius: 15px;
                            margin-bottom: 20px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        .image-container img {
                            width: 100%;
                            height: auto;
                            border-radius: 10px;
                            margin-bottom: 15px;
                        }
                        .image-info {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            color: #666;
                            font-size: 14px;
                            margin-bottom: 10px;
                        }
                        .save-hint {
                            background: #fff3cd;
                            color: #856404;
                            padding: 12px;
                            border-radius: 8px;
                            font-size: 13px;
                            text-align: center;
                            border: 1px solid #ffeaa7;
                        }
                        .close-btn {
                            position: fixed;
                            bottom: 20px;
                            right: 20px;
                            background: #2196f3;
                            color: white;
                            border: none;
                            border-radius: 50%;
                            width: 56px;
                            height: 56px;
                            font-size: 24px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            cursor: pointer;
                            z-index: 1000;
                        }
                        .close-btn:hover {
                            background: #1976d2;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2 style="margin: 0 0 10px 0; color: #333;">ğŸ“± é€ä¸ªæ‰‹åŠ¨ä¿å­˜</h2>
                        <div class="instruction">
                            <strong>ğŸ’¡ ä¿å­˜æ–¹æ³•ï¼š</strong><br>
                            1. âœ‹ é•¿æŒ‰å›¾ç‰‡<br>
                            2. ğŸ“‹ é€‰æ‹©"ä¿å­˜å›¾ç‰‡"æˆ–"ä¿å­˜åˆ°ç›¸å†Œ"<br>
                            3. ğŸ”„ é€ä¸ªä¿å­˜æ‰€æœ‰å›¾ç‰‡
                        </div>
                    </div>
                    <div id="images-container"></div>
                    <button class="close-btn" onclick="window.close()">âœ•</button>
                </body>
            </html>
        `);
        
        const imagesContainer = newWindow.document.getElementById('images-container');
        
        state.images.forEach((img, i) => {
            const canvas = createWatermarkedCanvas(img);
            const dataUrl = canvas.toDataURL('image/png');
            
            const imageContainer = newWindow.document.createElement('div');
            imageContainer.className = 'image-container';
            imageContainer.innerHTML = `
                <div class="image-info">
                    <span style="font-weight: bold; color: #333;">å›¾ç‰‡ ${i + 1}</span>
                    <span>å°ºå¯¸: ${img.width}Ã—${img.height}</span>
                </div>
                <img src="${dataUrl}" alt="æ°´å°å›¾ç‰‡${i + 1}">
                <div class="save-hint">
                    ğŸ‘† é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡ä¿å­˜
                </div>
            `;
            
            imagesContainer.appendChild(imageContainer);
        });
        
        closeBatchDownloadModal();
    }

    // æ‰¹é‡ä¸‹è½½ä¸ºZIP
    async function downloadAsZip() {
        if (state.images.length === 0) return;
        
        els.downloadProgressSimple.classList.remove('hidden');
        els.downloadProgressSimple.querySelector('.mb-2').textContent = 'æ­£åœ¨ç”ŸæˆZIP...';
        
        try {
            const zip = new JSZip();
            
            for (let i = 0; i < state.images.length; i++) {
                const canvas = createWatermarkedCanvas(state.images[i]);
                const dataUrl = canvas.toDataURL('image/png');
                const base64Data = dataUrl.split(',')[1];
                zip.file(`æ°´å°å›¾ç‰‡_${i + 1}.png`, base64Data, { base64: true });
            }
            
            const content = await zip.generateAsync({ type: 'blob' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `æ°´å°å›¾ç‰‡_${new Date().toISOString().slice(0, 10)}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(link.href);
            
        } catch (error) {
            console.error('ZIPç”Ÿæˆå¤±è´¥:', error);
            alert('ZIPæ–‡ä»¶ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
        } finally {
            els.downloadProgressSimple.classList.add('hidden');
        }
        
        closeBatchDownloadModal();
    }

    // æ˜¾ç¤ºæ‰¹é‡ä¸‹è½½é€‰æ‹©çª—å£
    function showBatchDownloadModal() {
        els.batchDownloadModal.classList.remove('hidden');
        // é‡ç½®å¤åˆ¶æŒ‰é’®çŠ¶æ€
        els.copyImageBtn.textContent = 'ğŸ“‹ å¤åˆ¶å›¾ç‰‡åˆ°å‰ªè´´æ¿';
        els.copyImageBtn.disabled = false;
        state.currentCopyIndex = 0;
    }

    // å…³é—­æ‰¹é‡ä¸‹è½½é€‰æ‹©çª—å£
    function closeBatchDownloadModal() {
        els.batchDownloadModal.classList.add('hidden');
    }

    // Event Listeners
    
    // ä¸»æ–‡ä»¶è¾“å…¥ï¼ˆé»˜è®¤ç›¸å†Œï¼‰
    els.imageInput.onchange = e => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files);
        }
    };
    
    // ç›¸æœºè¾“å…¥
    els.cameraInput.onchange = e => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files);
        }
    };
    
    // æ–‡ä»¶è¾“å…¥
    els.fileInput.onchange = e => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files);
        }
    };
    
    // é¢å¤–é€‰é¡¹æŒ‰é’®
    els.optionCamera.onclick = () => {
        els.cameraInput.click();
    };
    
    els.optionFiles.onclick = () => {
        els.fileInput.click();
    };

    els.fullscreenWatermark.onchange = () => {
        updateUIState();
        updatePreviews();
    };

    els.positionPreset.onchange = e => {
        if (POSITIONS[e.target.value]) {
            state.watermarkPos = { ...POSITIONS[e.target.value] };
            updatePreviews();
        }
    };

    els.spacing.oninput = () => {
        els.spacingValue.textContent = els.spacing.value;
        updatePreviews();
    };

    els.imagePreview.onmousedown = e => {
        if (!e.target.classList.contains('drag-overlay') || els.fullscreenWatermark.checked) return;
        e.preventDefault();
        state.isDragging = true;
        state.currentCanvas = e.target.previousElementSibling;
        state.dragStartPos = state.currentCanvas.getBoundingClientRect();
        els.positionPreset.value = 'custom';
    };

    document.onmousemove = e => {
        if (!state.isDragging || !state.dragStartPos || els.fullscreenWatermark.checked) return;
        const rect = state.dragStartPos;
        state.watermarkPos = {
            x: Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width)),
            y: Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height))
        };
        updatePreviews();
    };

    document.onmouseup = () => {
        state.isDragging = false;
        state.currentCanvas = null;
        state.dragStartPos = null;
    };

    [els.watermarkText, els.fontFamily, els.fontSize, els.opacity].forEach(el => {
        el.oninput = () => {
            if (el === els.fontSize) els.fontSizeValue.textContent = el.value;
            if (el === els.opacity) els.opacityValue.textContent = el.value;
            updatePreviews();
        };
    });

    document.querySelectorAll('input[name="fontWeight"]').forEach(el => {
        el.onchange = updatePreviews;
    });

    els.downloadAll.onclick = () => {
        const win = window.open('', '_blank');
        win.document.write(`
            <html><head><title>æ°´å°å›¾ç‰‡é¢„è§ˆ</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                body { margin: 20px; font-family: sans-serif; }
                .img-wrap { margin-bottom: 20px; }
                img { max-width: 100%; height: auto; display: block; margin-bottom: 10px; }
                p { margin: 5px 0; color: #666; }
                .tip { background: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
            </style>
            </head><body>
            <div class="tip">
                <strong>ä¿å­˜è¯´æ˜ï¼š</strong><br>
                â€¢ ç”µè„‘ç«¯ï¼šå³é”®å›¾ç‰‡é€‰æ‹©"å¦å­˜ä¸º"<br>
                â€¢ æ‰‹æœºç«¯ï¼šé•¿æŒ‰å›¾ç‰‡é€‰æ‹©"ä¿å­˜åˆ°ç›¸å†Œ"
            </div>
        `);
        
        state.images.forEach((img, i) => {
            const canvas = createWatermarkedCanvas(img);
            win.document.write(`
                <div class="img-wrap">
                    <img src="${canvas.toDataURL('image/png')}" alt="æ°´å°å›¾ç‰‡${i + 1}">
                    <p>æ°´å°å›¾ç‰‡ ${i + 1}</p>
                </div>
            `);
        });
        
        win.document.write('</body></html>');
        win.document.close();
    };

    // ä¿å­˜æ‰€æœ‰å›¾ç‰‡æŒ‰é’®
    els.saveAll.onclick = () => {
        if (isMobile()) {
            showBatchDownloadModal();
        } else {
            // PCç«¯ï¼šæ‰¹é‡ä¸‹è½½
            state.images.forEach((img, i) => {
                setTimeout(() => {
                    downloadSingleImage(createWatermarkedCanvas(img), i + 1);
                }, i * 200);
            });
        }
    };

    els.downloadZip.onclick = downloadAsZip;

    // æ‰¹é‡ä¸‹è½½æ¨¡æ€æ¡†äº‹ä»¶
    els.combinedImageBtn.onclick = createCombinedImage;
    els.manualDownloadBtn.onclick = createManualDownloadPage;
    els.copyImageBtn.onclick = copyImageToClipboard;
    els.zipDownloadBtn.onclick = downloadAsZip;
    els.closeModal.onclick = closeBatchDownloadModal;

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    els.batchDownloadModal.onclick = (e) => {
        if (e.target === els.batchDownloadModal) {
            closeBatchDownloadModal();
        }
    };

    // åˆå§‹åŒ–
    updateUIState();
})();
</script>
