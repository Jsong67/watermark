<!DOCTYPE html>
<html lang="en">
<!-- 前面的 HEAD 部分保持不变直到 body 开始 -->
<body class="bg-gray-50">
    <div class="max-w-3xl mx-auto p-4 space-y-4">
        <!-- 在字体选择后，添加水印位置选择器 -->
        <div class="grid grid-cols-2 gap-4">
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Watermark Text</label>
                <input type="text" id="watermarkText" value="Watermark" 
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
            </div>
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Font Family</label>
                <select id="fontFamily" 
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    <option value="Roboto">Roboto</option>
                    <option value="Playfair Display">Playfair Display</option>
                    <option value="Montserrat">Montserrat</option>
                    <option value="Open Sans">Open Sans</option>
                    <option value="Lora">Lora</option>
                </select>
            </div>
        </div>

        <!-- 添加水印位置选择器 -->
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Watermark Position</label>
            <select id="watermarkPosition" 
                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                <option value="center" selected>Center</option>
                <option value="top-left">Top Left</option>
                <option value="top-right">Top Right</option>
                <option value="bottom-left">Bottom Left</option>
                <option value="bottom-right">Bottom Right</option>
            </select>
        </div>

        <!-- 其余的 HTML 保持不变 -->

    </div>

    <script>
        // 在 state 对象中添加位置映射
        const state = {
            images: [],
            watermarkPos: { x: 0.5, y: 0.5 },
            isDragging: false,
            dragStartPos: null,
            currentCanvas: null,
            positions: {
                'center': { x: 0.5, y: 0.5 },
                'top-left': { x: 0.1, y: 0.1 },
                'top-right': { x: 0.9, y: 0.1 },
                'bottom-left': { x: 0.1, y: 0.9 },
                'bottom-right': { x: 0.9, y: 0.9 }
            }
        };

        // 在 elements 对象中添加位置选择器
        const elements = {
            // ... 原有的 elements
            watermarkPosition: document.getElementById('watermarkPosition')
        };

        // 添加位置选择器变化事件处理函数
        function handlePositionChange(e) {
            const position = e.target.value;
            if (state.positions[position]) {
                state.watermarkPos = { ...state.positions[position] };
                updateAllPreviews();
            }
        }

        // 修改 handleDrag 函数，在拖动后更新下拉选择器
        function handleDrag(e) {
            if (!state.isDragging || !state.currentCanvas) return;
            
            const rect = state.dragStartPos.rect;
            
            let newX = (e.clientX - rect.left) / rect.width;
            let newY = (e.clientY - rect.top) / rect.height;
            
            newX = Math.max(0, Math.min(1, newX));
            newY = Math.max(0, Math.min(1, newY));
            
            state.watermarkPos.x = newX;
            state.watermarkPos.y = newY;
            
            // 更新下拉选择器的值
            updatePositionSelector(newX, newY);
            
            updateAllPreviews();
        }

        // 添加更新位置选择器的函数
        function updatePositionSelector(x, y) {
            // 定义一个小的阈值来判断是否接近预设位置
            const threshold = 0.1;
            
            // 检查当前位置是否接近任何预设位置
            for (const [position, coords] of Object.entries(state.positions)) {
                if (Math.abs(x - coords.x) < threshold && Math.abs(y - coords.y) < threshold) {
                    elements.watermarkPosition.value = position;
                    return;
                }
            }
            
            // 如果不接近任何预设位置，选择 "Custom"
            if (!elements.watermarkPosition.querySelector('option[value="custom"]')) {
                const customOption = document.createElement('option');
                customOption.value = 'custom';
                customOption.textContent = 'Custom Position';
                elements.watermarkPosition.appendChild(customOption);
            }
            elements.watermarkPosition.value = 'custom';
        }

        // 在事件监听器部分添加位置选择器的监听
        elements.watermarkPosition.addEventListener('change', handlePositionChange);

        // 修改图片上传事件监听器，添加位置初始化
        elements.imageInput.addEventListener('change', async (e) => {
            state.images = await Promise.all(Array.from(e.target.files).map(loadImage));
            elements.previewArea.classList.remove('hidden');
            // 设置默认中心位置
            elements.watermarkPosition.value = 'center';
            state.watermarkPos = { ...state.positions['center'] };
            updateAllPreviews();
        });

        // 其余代码保持不变...
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html>
