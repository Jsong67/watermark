<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片批量加水印工具【+7AI实验室】</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&family=ZCOOL+KuaiLe&family=ZCOOL+QingKe+HuangYou&display=swap">
    <style>
        .canvas-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }
        .drag-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 40px;
            cursor: move;
        }
        .button-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: rgba(0,0,0,0.05);
        }
        .save-button {
            padding: 4px 12px;
            background: #4F46E5;
            color: white;
            border-radius: 4px;
            font-size: 14px;
        }
        .save-button:hover {
            background: #4338CA;
        }
        .extract-button {
            padding: 4px 12px;
            background: #10B981;
            color: white;
            border-radius: 4px;
            font-size: 14px;
        }
        .extract-button:hover {
            background: #059669;
        }
        .font-msz {
            font-family: 'Ma Shan Zheng', cursive;
        }
        .font-xw {
            font-family: 'ZCOOL XiaoWei', cursive;
        }
        .font-kl {
            font-family: 'ZCOOL KuaiLe', cursive;
        }
        .font-qkhy {
            font-family: 'ZCOOL QingKe HuangYou', cursive;
        }
        .font-noto {
            font-family: 'Noto Sans SC', sans-serif;
        }
        .banner-container {
            width: 100%;
            margin: 0 auto;
            padding: 1rem 0;
            text-align: center;
            background-color: #ffffff;
            max-width: 56rem;
        }
        .banner-image {
            width: 100%;
            height: auto;
            margin: 0 auto;
            display: block;
        }
        .fullscreen-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .download-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Banner -->
    <div class="max-w-4xl mx-auto">  
        <div class="banner-container">  
            <img src="https://i.ibb.co/NYByV7m/plus7banner.png"   
                 alt="plus7banner"  
                 class="banner-image">  
        </div>  
    </div>  

    <div class="max-w-4xl mx-auto p-4 space-y-6">
        <h1 class="text-2xl font-bold text-gray-900 text-center">图片批量加水印工具</h1>
        <p class="text-right text-sm text-gray-500 mt-1">Designed by Yufan Chen & Jiaqi Song & AI</p>
        <div class="bg-white rounded-lg shadow p-6 space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">选择图片</label>
                <input type="file" id="imageInput" multiple accept="image/*" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-md file:border-0
                    file:text-sm file:font-semibold
                    file:bg-indigo-50 file:text-indigo-700
                    hover:file:bg-indigo-100">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">水印文字</label>
                    <input type="text" id="watermarkText" value="+7AI实验室" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">字体选择</label>
                    <select id="fontFamily" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="Noto Sans SC" class="font-noto">思源黑体</option>
                        <option value="Ma Shan Zheng" class="font-msz">马善政毛笔字体</option>
                        <option value="ZCOOL XiaoWei" class="font-xw">站酷小薇字体</option>
                        <option value="ZCOOL KuaiLe" class="font-kl">站酷快乐体</option>
                        <option value="ZCOOL QingKe HuangYou" class="font-qkhy">站酷庆科黄油体</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">水印模式</label>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="fullscreenWatermark" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <span class="ml-2 text-sm">全屏水印</span>
                        </label>
                    </div>
                </div>
                <div class="space-y-2" id="positionContainer">
                    <label class="block text-sm font-medium text-gray-700">位置预设</label>
                    <select id="positionPreset" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="center">居中</option>
                        <option value="top-left">左上角</option>
                        <option value="top-right">右上角</option>
                        <option value="bottom-left">左下角</option>
                        <option value="bottom-right">右下角</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">字体粗细</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="fontWeight" value="normal" checked>
                            <span class="ml-2">常规</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="fontWeight" value="bold">
                            <span class="ml-2">加粗</span>
                        </label>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">
                        字体大小：<span id="fontSizeValue">5</span>%
                    </label>
                    <input type="range" id="fontSize" min="1" max="20" value="5" step="0.5" class="w-full">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">
                        可见水印透明度：<span id="opacityValue">50</span>%
                    </label>
                    <input type="range" id="opacity" min="10" max="100" value="50" class="w-full">
                </div>
                <div class="space-y-2" id="spacingContainer">
                    <label class="block text-sm font-medium text-gray-700">
                        水印间距：<span id="spacingValue">150</span>px
                    </label>
                    <input type="range" id="spacing" min="80" max="300" value="150" class="w-full">
                </div>
            </div>

            <div id="previewArea" class="hidden space-y-4">
                <h3 class="font-medium text-lg">预览（<span id="dragHint">拖动可调整可见水印位置</span>）</h3>
                <div id="imagePreview" class="grid gap-4"></div>
                <div class="flex gap-4">
                    <button id="downloadAll" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                        在新页面中查看
                    </button>
                    <button id="saveAll" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                        保存所有图片
                    </button>
                    <button id="downloadZip" class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">
                        打包下载ZIP
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 下载进度提示 -->
    <div id="downloadProgress" class="download-progress hidden">
        <div class="mb-2">正在生成ZIP文件...</div>
        <div class="text-sm opacity-75">请稍候，文件较大时可能需要一些时间</div>
    </div>
</body>
</html>

<script>
(() => {
    const state = {
        images: [],
        watermarkPos: { x: 0.5, y: 0.5 },
        isDragging: false,
        dragStartPos: null,
        currentCanvas: null
    };

    const POSITIONS = {
        'center': { x: 0.5, y: 0.5 },
        'top-left': { x: 0.01, y: 0.01 },
        'top-right': { x: 0.99, y: 0.01 },
        'bottom-left': { x: 0.01, y: 0.99 },
        'bottom-right': { x: 0.99, y: 0.99 }
    };

    const $ = id => document.getElementById(id);
    const els = {
        imageInput: $('imageInput'),
        watermarkText: $('watermarkText'),
        fontSize: $('fontSize'),
        fontFamily: $('fontFamily'),
        opacity: $('opacity'),
        spacing: $('spacing'),
        previewArea: $('previewArea'),
        imagePreview: $('imagePreview'),
        downloadAll: $('downloadAll'),
        saveAll: $('saveAll'),
        downloadZip: $('downloadZip'),
        fontSizeValue: $('fontSizeValue'),
        opacityValue: $('opacityValue'),
        spacingValue: $('spacingValue'),
        positionPreset: $('positionPreset'),
        fullscreenWatermark: $('fullscreenWatermark'),
        positionContainer: $('positionContainer'),
        spacingContainer: $('spacingContainer'),
        dragHint: $('dragHint'),
        downloadProgress: $('downloadProgress')
    };

    // 检测是否为移动设备
    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // LSB水印编码函数
    function encodeLSB(imageData, text) {
        const data = new Uint8ClampedArray(imageData.data);
        const binaryText = textToBinary(text);
        const bits = 2;
        const mask = (1 << bits) - 1;
        const inverseMask = ~mask & 0xFF;
        
        const textLength = binaryText.length;
        for(let i = 0; i < 32; i++) {
            const lengthBit = (textLength >> i) & 1;
            data[i * 4] = (data[i * 4] & inverseMask) | lengthBit;
        }

        for(let i = 0; i < binaryText.length; i++) {
            const pixelIndex = (i + 32) * 4;
            if(pixelIndex >= data.length) break;
            
            const textBits = parseInt(binaryText.substr(i * bits, bits) || '0', 2);
            data[pixelIndex] = (data[pixelIndex] & inverseMask) | textBits;
        }

        return new ImageData(data, imageData.width, imageData.height);
    }

    // LSB水印解码函数
    function decodeLSB(imageData) {
        const data = imageData.data;
        let textLength = 0;
        const bits = 2;

        for(let i = 0; i < 32; i++) {
            const lengthBit = data[i * 4] & 1;
            textLength |= (lengthBit << i);
        }

        let binaryText = '';
        const mask = (1 << bits) - 1;
        
        for(let i = 0; i < textLength; i++) {
            const pixelIndex = (i + 32) * 4;
            if(pixelIndex >= data.length) break;
            
            const textBits = data[pixelIndex] & mask;
            binaryText += textBits.toString(2).padStart(bits, '0');
        }

        return binaryToText(binaryText);
    }

    function textToBinary(text) {
        let binary = '';
        for(let i = 0; i < text.length; i++) {
            binary += text.charCodeAt(i).toString(2).padStart(16, '0');
        }
        return binary;
    }

    function binaryToText(binary) {
        let text = '';
        for(let i = 0; i < binary.length; i += 16) {
            const charCode = parseInt(binary.substr(i, 16), 2);
            if(charCode === 0) break;
            text += String.fromCharCode(charCode);
        }
        return text;
    }

    function loadImage(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // 优化后的全屏水印绘制函数
    function drawFullscreenWatermark(ctx, canvas, text, fontSize, opacity, weight, fontFamily) {
        const spacing = parseInt(els.spacing.value);
        
        ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
        ctx.font = `${weight} ${fontSize}px ${fontFamily}`;
        
        // 计算文本尺寸
        const textMetrics = ctx.measureText(text);
        const textWidth = textMetrics.width;
        const textHeight = fontSize;
        
        // 计算间距（确保合理的最小间距）
        const stepX = Math.max(textWidth + spacing, 100);
        const stepY = Math.max(textHeight + spacing, 60);
        
        // 保存当前状态
        ctx.save();
        
        // 设置旋转角度（-45度，更自然的水印效果）
        const angle = -Math.PI / 4;
        
        // 移动到画布中心并旋转
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(angle);
        
        // 计算旋转后需要覆盖的区域大小
        const diagonal = Math.sqrt(canvas.width * canvas.width + canvas.height * canvas.height);
        const coverSize = diagonal * 1.2; // 稍微扩大覆盖范围
        
        // 计算行列数（限制最大数量以防止性能问题）
        const maxCols = Math.min(Math.ceil(coverSize / stepX), 20);
        const maxRows = Math.min(Math.ceil(coverSize / stepY), 20);
        
        // 计算起始位置（居中绘制）
        const startX = -(maxCols * stepX) / 2;
        const startY = -(maxRows * stepY) / 2;
        
        // 绘制水印网格
        for(let row = 0; row < maxRows; row++) {
            for(let col = 0; col < maxCols; col++) {
                const x = startX + col * stepX;
                const y = startY + row * stepY;
                ctx.fillText(text, x, y);
            }
        }
        
        // 恢复状态
        ctx.restore();
    }

    function createWatermarkedCanvas(img) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        
        // 绘制原始图片
        ctx.drawImage(img, 0, 0);
        
        // 添加LSB水印
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const watermarkedData = encodeLSB(imageData, els.watermarkText.value);
        ctx.putImageData(watermarkedData, 0, 0);
        
        // 添加可见水印
        const opacity = els.opacity.value / 100;
        const weight = document.querySelector('input[name="fontWeight"]:checked').value;
        const fontSize = Math.round((els.fontSize.value / 100) * canvas.height);
        const text = els.watermarkText.value;
        const fontFamily = els.fontFamily.value;
        
        if (els.fullscreenWatermark.checked) {
            // 全屏水印
            drawFullscreenWatermark(ctx, canvas, text, fontSize, opacity, weight, fontFamily);
        } else {
            // 单个水印
            ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
            ctx.font = `${weight} ${fontSize}px ${fontFamily}`;
            
            const x = state.watermarkPos.x * canvas.width;
            const y = state.watermarkPos.y * canvas.height;
            
            ctx.textAlign = x < canvas.width * 0.4 ? 'left' : x > canvas.width * 0.6 ? 'right' : 'center';
            ctx.textBaseline = y < canvas.height * 0.4 ? 'top' : y > canvas.height * 0.6 ? 'bottom' : 'middle';
            
            ctx.fillText(text, x, y);
        }
        
        return canvas;
    }

    function extractWatermark(img, resultContainer) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const extractedText = decodeLSB(imageData);
        
        resultContainer.classList.remove('hidden');
        resultContainer.innerHTML = extractedText ? 
            `<div class="bg-green-50 border border-green-200 rounded-md p-4 mt-2">
                <p class="text-green-800">提取到水印内容：<span class="font-semibold">"${extractedText}"</span></p>
            </div>` : 
            `<div class="bg-red-50 border border-red-200 rounded-md p-4 mt-2">
                <p class="text-red-800">未检测到水印或水印已损坏</p>
            </div>`;
    }

    function updateUIState() {
        const isFullscreen = els.fullscreenWatermark.checked;
        
        // 控制位置相关控件的可用性
        els.positionContainer.classList.toggle('fullscreen-disabled', isFullscreen);
        els.spacingContainer.classList.toggle('hidden', !isFullscreen);
        
        // 更新拖拽提示
        els.dragHint.textContent = isFullscreen ? '全屏水印模式' : '拖动可调整可见水印位置';
        
        // 禁用/启用拖拽功能
        const overlays = document.querySelectorAll('.drag-overlay');
        overlays.forEach(overlay => {
            overlay.style.pointerEvents = isFullscreen ? 'none' : 'auto';
        });
    }

    function updatePreviews() {
        els.imagePreview.innerHTML = '';
        
        state.images.forEach((img, i) => {
            const container = document.createElement('div');
            container.className = 'space-y-2';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'canvas-wrapper';
            
            const canvas = createWatermarkedCanvas(img);
            canvas.className = 'w-full h-auto border rounded';
            
            const overlay = document.createElement('div');
            overlay.className = 'drag-overlay';
            overlay.style.height = 'calc(100% - 40px)';
            overlay.style.pointerEvents = els.fullscreenWatermark.checked ? 'none' : 'auto';
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'button-container';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'save-button';
            saveBtn.textContent = '保存';
            saveBtn.onclick = (e) => {
                e.stopPropagation();
                downloadSingleImage(canvas, i + 1);
            };

            const extractBtn = document.createElement('button');
            extractBtn.className = 'extract-button';
            extractBtn.textContent = '提取水印';
            
            const resultContainer = document.createElement('div');
            resultContainer.className = 'hidden';
            
            extractBtn.onclick = (e) => {
                e.stopPropagation();
                extractWatermark(img, resultContainer);
            };
            
            buttonContainer.append(saveBtn, extractBtn);
            wrapper.append(canvas, overlay, buttonContainer);
            container.append(wrapper, resultContainer);
            els.imagePreview.appendChild(container);
        });
    }

    // 下载单个图片
    function downloadSingleImage(canvas, index) {
        if (isMobile()) {
            // 移动端：在新窗口中打开图片
            const dataUrl = canvas.toDataURL('image/png');
            const newWindow = window.open();
            newWindow.document.write(`
                <html>
                    <head>
                        <title>水印图片${index}</title>
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <style>
                            body { margin: 0; padding: 20px; text-align: center; }
                            img { max-width: 100%; height: auto; }
                            .tip { margin: 10px 0; color: #666; font-size: 14px; }
                        </style>
                    </head>
                    <body>
                        <div class="tip">长按图片选择保存到相册</div>
                        <img src="${dataUrl}" alt="水印图片${index}">
                    </body>
                </html>
            `);
        } else {
            // PC端：直接下载
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = `水印图片_${index}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    // 批量下载为ZIP
    async function downloadAsZip() {
        if (state.images.length === 0) return;
        
        els.downloadProgress.classList.remove('hidden');
        
        try {
            const zip = new JSZip();
            
            // 添加图片到ZIP
            for (let i = 0; i < state.images.length; i++) {
                const canvas = createWatermarkedCanvas(state.images[i]);
                const dataUrl = canvas.toDataURL('image/png');
                const base64Data = dataUrl.split(',')[1];
                zip.file(`水印图片_${i + 1}.png`, base64Data, { base64: true });
            }
            
            // 生成ZIP文件
            const content = await zip.generateAsync({ type: 'blob' });
            
            // 下载ZIP文件
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `水印图片_${new Date().toISOString().slice(0, 10)}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // 清理URL对象
            URL.revokeObjectURL(link.href);
            
        } catch (error) {
            console.error('ZIP生成失败:', error);
            alert('ZIP文件生成失败，请重试');
        } finally {
            els.downloadProgress.classList.add('hidden');
        }
    }

    // Event Listeners
    els.imageInput.onchange = async e => {
        state.images = await Promise.all(Array.from(e.target.files).map(loadImage));
        els.previewArea.classList.remove('hidden');
        updateUIState();
        updatePreviews();
    };

    els.fullscreenWatermark.onchange = () => {
        updateUIState();
        updatePreviews();
    };

    els.positionPreset.onchange = e => {
        if (POSITIONS[e.target.value]) {
            state.watermarkPos = { ...POSITIONS[e.target.value] };
            updatePreviews();
        }
    };

    els.spacing.oninput = () => {
        els.spacingValue.textContent = els.spacing.value;
        updatePreviews();
    };

    els.imagePreview.onmousedown = e => {
        if (!e.target.classList.contains('drag-overlay') || els.fullscreenWatermark.checked) return;
        e.preventDefault();
        state.isDragging = true;
        state.currentCanvas = e.target.previousElementSibling;
        state.dragStartPos = state.currentCanvas.getBoundingClientRect();
        els.positionPreset.value = 'custom';
    };

    document.onmousemove = e => {
        if (!state.isDragging || !state.dragStartPos || els.fullscreenWatermark.checked) return;
        const rect = state.dragStartPos;
        state.watermarkPos = {
            x: Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width)),
            y: Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height))
        };
        updatePreviews();
    };

    document.onmouseup = () => {
        state.isDragging = false;
        state.currentCanvas = null;
        state.dragStartPos = null;
    };

    [els.watermarkText, els.fontFamily, els.fontSize, els.opacity].forEach(el => {
        el.oninput = () => {
            if (el === els.fontSize) els.fontSizeValue.textContent = el.value;
            if (el === els.opacity) els.opacityValue.textContent = el.value;
            updatePreviews();
        };
    });

    document.querySelectorAll('input[name="fontWeight"]').forEach(el => {
        el.onchange = updatePreviews;
    });

    els.downloadAll.onclick = () => {
        const win = window.open('', '_blank');
        win.document.write(`
            <html><head><title>水印图片预览</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                body { margin: 20px; font-family: sans-serif; }
                .img-wrap { margin-bottom: 20px; }
                img { max-width: 100%; height: auto; display: block; margin-bottom: 10px; }
                p { margin: 5px 0; color: #666; }
                .tip { background: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
            </style>
            </head><body>
            <div class="tip">
                <strong>保存说明：</strong><br>
                • 电脑端：右键图片选择"另存为"<br>
                • 手机端：长按图片选择"保存到相册"
            </div>
        `);
        
        state.images.forEach((img, i) => {
            const canvas = createWatermarkedCanvas(img);
            win.document.write(`
                <div class="img-wrap">
                    <img src="${canvas.toDataURL('image/png')}" alt="水印图片${i + 1}">
                    <p>水印图片 ${i + 1}</p>
                </div>
            `);
        });
        
        win.document.write('</body></html>');
        win.document.close();
    };

    els.saveAll.onclick = () => {
        if (isMobile()) {
            // 移动端提示用户使用其他方式
            alert('手机端建议使用"在新页面中查看"或"打包下载ZIP"功能');
            return;
        }
        
        // PC端批量下载
        state.images.forEach((img, i) => {
            setTimeout(() => {
                downloadSingleImage(createWatermarkedCanvas(img), i + 1);
            }, i * 200); // 添加延迟避免同时下载太多文件
        });
    };

    els.downloadZip.onclick = downloadAsZip;

    // 初始化UI状态
    updateUIState();
})();
</script>
